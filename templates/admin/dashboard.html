{% extends "admin/base.html" %}

{% block title %}Панель управления - XPOM-KZ{% endblock %}

{% block page_title %}Панель управления{% endblock %}

{% block content %}
<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">Всего заказов</div>
            <div class="stat-icon">
                <i class="fas fa-box"></i>
            </div>
        </div>
        <div class="stat-value">{{ stats.total_orders }}</div>
        <div class="stat-change positive">
            <i class="fas fa-arrow-up"></i>
            +12% за месяц
        </div>
    </div>

    <div class="stat-card warning">
        <div class="stat-header">
            <div class="stat-title">Новые заявки</div>
            <div class="stat-icon">
                <i class="fas fa-clock"></i>
            </div>
        </div>
        <div class="stat-value">{{ stats.new_orders }}</div>
        <div class="stat-change positive">
            <i class="fas fa-arrow-up"></i>
            +3 сегодня
        </div>
    </div>

    <div class="stat-card success">
        <div class="stat-header">
            <div class="stat-title">В пути</div>
            <div class="stat-icon">
                <i class="fas fa-truck"></i>
            </div>
        </div>
        <div class="stat-value">{{ stats.in_progress_orders }}</div>
        <div class="stat-change positive">
            <i class="fas fa-arrow-up"></i>
            +5 активных
        </div>
    </div>

    <div class="stat-card info">
        <div class="stat-header">
            <div class="stat-title">Доставлено</div>
            <div class="stat-icon">
                <i class="fas fa-check"></i>
            </div>
        </div>
        <div class="stat-value">{{ stats.delivered_orders }}</div>
        <div class="stat-change positive">
            <i class="fas fa-arrow-up"></i>
            +18 за неделю
        </div>
    </div>
</div>

<!-- Content Grid -->
<div class="row" style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin: 0;">
    <!-- Recent Orders -->
    <div class="content-card">
        <div class="card-header">
            <h3 class="card-title">Последние заказы</h3>
            <a href="{{ url_for('admin_orders') }}" class="btn btn-primary btn-sm">
                <i class="fas fa-eye"></i> Все заказы
            </a>
        </div>
        <div class="card-body">
            {% if recent_orders %}
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Номер</th>
                                <th>Клиент</th>
                                <th>Тип</th>
                                <th>Статус</th>
                                <th>Создан</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in recent_orders %}
                            <tr>
                                <td>
                                    <strong>{{ order.tracking_number }}</strong>
                                </td>
                                <td>
                                    <div>{{ order.customer_name }}</div>
                                    <small style="color: var(--gray-500);">{{ order.customer_phone | format_phone }}</small>
                                </td>
                                <td>
                                    <span class="status-badge status-{{ 'confirmed' if order.order_type == 'astana' else 'in-progress' }}">
                                        {{ 'Астана' if order.order_type == 'astana' else 'Казахстан' }}
                                    </span>
                                </td>
                                <td>
                                    <span class="status-badge status-{{ order.status }}">
                                        {{ order.get_status_display() }}
                                    </span>
                                </td>
                                <td>
                                    {{ order.created_at.strftime('%d.%m.%Y') }}
                                </td>
                                <td>
                                    <a href="{{ url_for('admin_order_detail', order_id=order.id) }}" class="btn btn-outline btn-sm">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5" style="color: var(--gray-500);">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <h5>Нет заказов</h5>
                    <p>Заказы будут отображаться здесь после создания</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Quick Actions & Info -->
    <div>
        <!-- Quick Actions -->
        <div class="content-card mb-4">
            <div class="card-header">
                <h3 class="card-title">Быстрые действия</h3>
            </div>
            <div class="card-body">
                <div class="d-grid gap-3">
                    <a href="{{ url_for('admin_orders', status='new') }}" class="btn btn-warning">
                        <i class="fas fa-clock"></i>
                        Новые заявки ({{ stats.new_orders }})
                    </a>
                    <a href="{{ url_for('admin_orders', status='in_progress') }}" class="btn btn-info">
                        <i class="fas fa-truck"></i>
                        В пути ({{ stats.in_progress_orders }})
                    </a>
                    <a href="{{ url_for('admin_reports') }}" class="btn btn-success">
                        <i class="fas fa-chart-line"></i>
                        Отчеты
                    </a>
                    <a href="{{ url_for('admin_analytics') }}" class="btn btn-primary">
                        <i class="fas fa-chart-pie"></i>
                        Аналитика
                    </a>
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="content-card">
            <div class="card-header">
                <h3 class="card-title">Система</h3>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span style="font-size: 14px; color: var(--gray-600);">База данных</span>
                        <span class="status-badge status-delivered">Активна</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span style="font-size: 14px; color: var(--gray-600);">Telegram бот</span>
                        <span class="status-badge status-delivered">Подключен</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span style="font-size: 14px; color: var(--gray-600);">Последнее обновление</span>
                        <span style="font-size: 13px; color: var(--gray-500);">Сейчас</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if charts_data %}
<!-- Charts Section -->
<div class="content-card mt-4">
    <div class="card-header">
        <h3 class="card-title">Статистика заказов за неделю</h3>
    </div>
    <div class="card-body">
        <canvas id="ordersChart" height="100"></canvas>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
{% if charts_data %}
<script>
// Orders Chart
document.addEventListener('DOMContentLoaded', function() {
    const chartCanvas = document.getElementById('ordersChart');
    if (chartCanvas) {
        const ctx = chartCanvas.getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ charts_data.labels | tojson | safe }},
                datasets: [{
                    label: 'Заказы',
                    data: {{ charts_data.orders | tojson | safe }},
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#e5e7eb'
                        },
                        ticks: {
                            color: '#6b7280'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#6b7280'
                        }
                    }
                },
                elements: {
                    point: {
                        radius: 6,
                        hoverRadius: 8,
                        backgroundColor: 'white',
                        borderWidth: 3
                    }
                }
            }
        });
    }
});
</script>
{% endif %}
{% endblock %}